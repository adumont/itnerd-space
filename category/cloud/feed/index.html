<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Cloud &#8211; IT Nerd Space</title>
	<atom:link href="http://itnerd.space/category/cloud/feed/" rel="self" type="application/rss+xml" />
	<link>http://itnerd.space</link>
	<description>Blog about Cloud, Automation, Android, Smart things...</description>
	<lastBuildDate>Thu, 27 Jul 2017 21:21:14 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://wordpress.org/?v=4.8</generator>

<image>
	<url>http://itnerd.space/wp-content/uploads/2016/10/cropped-99789e30b0a6eac11f33246750ca29f9-32x32.jpg</url>
	<title>Cloud &#8211; IT Nerd Space</title>
	<link>http://itnerd.space</link>
	<width>32</width>
	<height>32</height>
</image> 
	<item>
		<title>Looking back and Forward: Coming soon to this blog</title>
		<link>http://itnerd.space/2017/07/27/looking-back-and-forward-coming-soon-to-this-blog/</link>
		<comments>http://itnerd.space/2017/07/27/looking-back-and-forward-coming-soon-to-this-blog/#respond</comments>
		<pubDate>Thu, 27 Jul 2017 21:19:35 +0000</pubDate>
		<dc:creator><![CDATA[admin]]></dc:creator>
				<category><![CDATA[Automation]]></category>
		<category><![CDATA[Cloud]]></category>
		<category><![CDATA[How-to]]></category>

		<guid isPermaLink="false">http://itnerd.space/?p=361</guid>
		<description><![CDATA[Soon after having found out how to trigger one TP-Link HS100 smartplug , the most frequently asked question in the comments has been Â¿how can I power On/Off multiple devices from ITFFF? Probably the second to most request in the mind of all is related to the TOKEN that will eventually expired sooner of later, making it a hassle to edit all your IFTTT  applets manually... Until now! Read and Follow me! ]]></description>
				<content:encoded><![CDATA[<p><img data-attachment-id="193" data-permalink="http://itnerd.space/2017/01/22/how-to-control-your-tp-link-hs100-smartplug-from-internet/hs100_un_v1_1116_large_2-00_20151006093353/" data-orig-file="http://itnerd.space/wp-content/uploads/2017/01/HS100_un_V1_1116_large_2.00_20151006093353.jpg" data-orig-size="960,720" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="HS100_un_V1_1116_large_2.00_20151006093353" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2017/01/HS100_un_V1_1116_large_2.00_20151006093353-300x225.jpg" data-large-file="http://itnerd.space/wp-content/uploads/2017/01/HS100_un_V1_1116_large_2.00_20151006093353.jpg" class="alignright wp-image-193 " src="http://itnerd.space/wp-content/uploads/2017/01/HS100_un_V1_1116_large_2.00_20151006093353-300x225.jpg" alt="" width="211" height="158" srcset="http://itnerd.space/wp-content/uploads/2017/01/HS100_un_V1_1116_large_2.00_20151006093353-300x225.jpg 300w, http://itnerd.space/wp-content/uploads/2017/01/HS100_un_V1_1116_large_2.00_20151006093353-768x576.jpg 768w, http://itnerd.space/wp-content/uploads/2017/01/HS100_un_V1_1116_large_2.00_20151006093353-30x23.jpg 30w, http://itnerd.space/wp-content/uploads/2017/01/HS100_un_V1_1116_large_2.00_20151006093353.jpg 960w" sizes="(max-width: 211px) 100vw, 211px" />I started this blog writing a series of articles about <a href="http://itnerd.space/tag/azure/">Azure App Service Architecture</a>, mainly trying to explain and illustrate how I understand it works, beyond what one can find publicly in Microsoft (extensive) documentation. Then I got an HS100 TP-Link smartplug: a &#8220;connected thing&#8221;, a plug that is connected to Internet (don&#8217;t say that to any person, most will look at you like o.0?!), a plug that you can control from an App on your phone, from wherever you are: at home, or from outside: from anywhere in the world. And Â I guess Oops I did it again!</p>
<h2>Interface the HS100 with everything</h2>
<p>I couldn&#8217;t resist to imagine many potential applications and possible integrations with online (cloud) services that are publicly and freely available, like IFTTT; I&#8217;m also a big fan of Android Tasker, Node-Red, the MQTT pub/sub protocol, and Raspberry Pi / NodeMCU hooked with sensors and hardware pieces attached on the GPIO pins) that make more <em>connected things</em>, so literally ideas are all over the places in my heads, on papers, in Keep notes&#8230;</p>
<p>Like this one that just popped in my mind:</p>
<blockquote><p>Switch off the main lights in the salon, dim the lights around the sofa and TV, power on the media server box (smartplug) and TV when I sit on the sofa, with a NodeMCUÂ controller and a pressure sensor (<a href="https://www.youtube.com/watch?v=rTO3U-0Njtw">FSR</a>)! Or maybe I&#8217;d prefer to have all that triggered when I power on the TV, but only in a certain time slot?&#8230;</p></blockquote>
<p>Told you I have crasy ideas ;). Totally got to try to do that BTW!</p>
<h2>Error: Time not found</h2>
<p>What I only lack really is time. First, time to try and make some of those idea work (they do eventually with perseverence and I always learn a lot in the process), then time to write about them (here).</p>
<p>I didn&#8217;t realize the time it take to write articles people need to write good articles. I usually take notes of what I do, notes that I understand, but publishing those is no value to anyone. You need to structure the ideas, give them some form so the result make sense for the reader, enough at least so they can be inspired in trying also themselves to do, learn and make something that work for them out of what I wrote. Unfortunately due to the lack of time, I don&#8217;t enter into too much details, and I assume the reader is tech-savvy enough to read, understand and try by himself. That means some reader gets frustrated because I missed some parts they didn&#8217;t know&#8230; Sorry about that.</p>
<h2>Wins so far</h2>
<p>Back to the HS100: there were some (very good) resources publicly available already out there that showed how to interact with an HS100 plug, from shell scripts based on cURL, php and python libraries or Node.js modules, even a Node-Red. But they all had the same problem: they only worked withing the same local network (WiFi/LAN) the plug was connected to. Ugh bummer.</p>
<p>The Kasa App and the Alexa integration were proof that TP-Link was hosting a cloud service, but no API was publicly available yet.</p>
<p>So I started to work on figuring out how the App talked to the TP-Link Cloud endpoint, and started to publish it here.Â The series got (modestly) popular among the maker and tinkerers ;), and people used the comments to exchange ideas, issues, and come with solutions.Â So far, I&#8217;ve published (not in chronological order)</p>
<ul>
<li><a href="http://itnerd.space/2017/01/22/how-to-control-your-tp-link-hs100-smartplug-from-internet/">Retrieve token and deviceID from Kasa App on Android</a>Â (this is how everything started)<a href="http://itnerd.space/wp-content/uploads/2017/04/aimg_20170402_165806-01.jpg" rel="attachment wp-att-293"><img data-attachment-id="293" data-permalink="http://itnerd.space/2017/04/03/control-your-tp-link-hs100-smart-plug-from-your-android-watch/aimg_20170402_165806-01/" data-orig-file="http://itnerd.space/wp-content/uploads/2017/04/aimg_20170402_165806-01.jpg" data-orig-size="780,520" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;2&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;1039348800&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;3.79&quot;,&quot;iso&quot;:&quot;515&quot;,&quot;shutter_speed&quot;:&quot;0.03030303030303&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="aimg_20170402_165806-01" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2017/04/aimg_20170402_165806-01-300x200.jpg" data-large-file="http://itnerd.space/wp-content/uploads/2017/04/aimg_20170402_165806-01.jpg" class="alignright wp-image-293 size-thumbnail" src="http://itnerd.space/wp-content/uploads/2017/04/aimg_20170402_165806-01-150x150.jpg" alt="" width="150" height="150" srcset="http://itnerd.space/wp-content/uploads/2017/04/aimg_20170402_165806-01-150x150.jpg 150w, http://itnerd.space/wp-content/uploads/2017/04/aimg_20170402_165806-01-100x100.jpg 100w" sizes="(max-width: 150px) 100vw, 150px" /></a></li>
<li><a href="http://itnerd.space/2017/06/19/how-to-authenticate-to-tp-link-cloud-api/">Login to TP-Link (with your username and password) and retrieve token</a>
<ul>
<li>also <a href="http://itnerd.space/2017/06/19/how-to-authenticate-to-tp-link-cloud-api-with-tasker/">&#8230;with Tasker</a></li>
</ul>
</li>
<li><a href="http://itnerd.space/2017/05/21/how-to-get-the-tp-link-hs100-cloud-end-point-url/">Retrieve the cloud end point URL</a> and <a href="http://itnerd.space/2017/05/21/how-to-get-the-tp-link-hs100-cloud-end-point-url/">list of your TP-Link devices (with deviceID)</a></li>
<li>Set the plug state (on/off) remotely (once you have Token, DeviceID, and URL)
<ul>
<li><a href="http://itnerd.space/2017/01/22/how-to-control-your-tp-link-hs100-smartplug-from-internet/">with cURL or Hurl.it (command line, shell scripts,&#8230;)</a></li>
<li><a href="http://itnerd.space/2017/01/22/control-your-tp-link-hs100-smart-plug-with-ifttt/">with IFTT</a></li>
<li><a href="http://itnerd.space/2017/02/26/control-your-tp-link-hs100-smartplug-with-tasker/">with Tasker</a></li>
<li><a href="http://itnerd.space/2017/04/03/control-your-tp-link-hs100-smart-plug-from-your-android-watch/">from your Watch</a></li>
</ul>
</li>
</ul>
<p>So far the whole process was rather hacky and manual I reckon, but still one could achieve the goal of switching a smartplug from a remote place (outside of the smartplug local network), like from one&#8217;s smartphone (Tasker), or an IFTTT recipe. It already enabled some cool logics.</p>
<h2>Pitfalls: what about scenes?</h2>
<p>Soon after having found out how to trigger one TP-Link HS100 smartplug, the most frequently asked question in the comments has been <span style="color: #ff0000;">Â¿how can I power On/Off multiple devices from ITFFF?</span></p>
<p>After all it&#8217;s a feature that people know from the Kasa App: you define buttons in the app that will put several of you smartplugs in a state you define.</p>
<p>Related to my idea above, a scene would be:</p>
<blockquote><p>&#8220;Time to w<em>atch some TV</em>&#8221; scene: Switch off the main lights in the salon, dim the lights around the sofa and TV, power on the media server box (smartplug) and TV.</p></blockquote>
<p>You can define that in Kasa, but what about calling it from IFTTT? You can&#8217;t. You can only call one POST call (via Maker), in an IFTTT recipe.</p>
<p>The second to most request in the mind of all is probably related to the <span style="color: #ff0000;">TOKEN that will eventually expire</span> sooner of later, making it a hassle to edit all your IFTTT Recipes/Tasker tasks/whatever scripts&#8230; manually!</p>
<p>Well, I&#8217;m happy to say this was until now!</p>
<h1>More Wins coming soon&#8230;</h1>
<p>This week I&#8217;ve been working hard on this (it&#8217;s the second time I try it, and this time I made it!).</p>
<p>This is what I have done:</p>
<ul>
<li>I&#8217;ve created a <strong>node.js module</strong> to easily interact (power On/Off, get state) with any number of HS100/HS110 smartplugs and LB100/LB110/LB120 and LB130 smartbulbs (set on/off, set brightness, set color). The module handles the login, token retrieval, and device triggering, in almost no call.</li>
<li>I&#8217;ve created a <strong>Glitch example app</strong> in which one can define scenes. As Glitch publishes a URL, you can then trigger one &#8220;scene&#8221; with only one call (http://url.glich.me/scene1/) and with only one POST call it will do whatever you want to! Not only that but you can even define as many scenes as you want in a single Glitch app ( each with a different end-point: http://url.glich.me/scene2/, http://url.glich.me/scene3/&#8230;).</li>
</ul>
<p>All that is already working fine for me, so this is what I&#8217;ll talk about in next posts (and I&#8217;ll publish the code for everything <img src="https://s.w.org/images/core/emoji/2.3/72x72/1f609.png" alt="ðŸ˜‰" class="wp-smiley" style="height: 1em; max-height: 1em;" /> ) when I get some more time to talk about it. (Believe it or not, it took me more than two hours to write this post)!</p>
<p>So, if you are interested I suggest you follow me on Twitter, and follow this blog, recommend on Disqus (the heart icon).</p>
<p>Ah and well&#8230; all this is free, but you might see some interesting (or not) Ads around my content. I won&#8217;t mind if you all start clicking everywhere like Monkeys.Â I&#8217;m not suggesting anything&#8230; :p</p>
]]></content:encoded>
			<wfw:commentRss>http://itnerd.space/2017/07/27/looking-back-and-forward-coming-soon-to-this-blog/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Control your TP-Link HS100 smart plug with IFTTT</title>
		<link>http://itnerd.space/2017/01/22/control-your-tp-link-hs100-smart-plug-with-ifttt/</link>
		<comments>http://itnerd.space/2017/01/22/control-your-tp-link-hs100-smart-plug-with-ifttt/#comments</comments>
		<pubDate>Sun, 22 Jan 2017 16:32:43 +0000</pubDate>
		<dc:creator><![CDATA[Alex D.]]></dc:creator>
				<category><![CDATA[Automation]]></category>
		<category><![CDATA[Cloud]]></category>
		<category><![CDATA[How-to]]></category>
		<category><![CDATA[HS100]]></category>
		<category><![CDATA[IoT]]></category>
		<category><![CDATA[Smart Things]]></category>

		<guid isPermaLink="false">http://itnerd.space/?p=208</guid>
		<description><![CDATA[In my previous post we saw how we can control a TP-Link HS100 smart plug from command line from anywhere on Internet, without having to rely on the Kasa app, which unleashes a new world of possibilities. In this post we'll see how to switch the plug On/Off directly from IFTTT, without any third-party component, nor without any other device at home other than the smart plug itself.]]></description>
				<content:encoded><![CDATA[<p>In my previous post we saw how we can <a href="http://itnerd.space/2017/01/22/how-to-control-your-tp-link-hs100-smartplug-from-internet/">control a TP-Link HS100 smart plug from command line from anywhere on Internet</a>, without the Kasa app. In this post we&#8217;ll see how to switch the plug On/Off directly from IFTTT, without any third-party component, nor without any other device at home other than the smart plug itself.</p>
<p>In IFTTT we&#8217;ll use the Maker service, which let&#8217;s us call a custom HTTP GET/POST request with some Json payload, so that&#8217;s exactly what we need here.</p>
<p><img data-attachment-id="209" data-permalink="http://itnerd.space/2017/01/22/control-your-tp-link-hs100-smart-plug-with-ifttt/makeractionserviceifttt/" data-orig-file="http://itnerd.space/wp-content/uploads/2017/01/MakerActionServiceIFTTT.png" data-orig-size="310,310" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="MakerActionServiceIFTTT" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2017/01/MakerActionServiceIFTTT-300x300.png" data-large-file="http://itnerd.space/wp-content/uploads/2017/01/MakerActionServiceIFTTT.png" class="size-thumbnail wp-image-209 alignright" src="http://itnerd.space/wp-content/uploads/2017/01/MakerActionServiceIFTTT-150x150.png" alt="" width="150" height="150" srcset="http://itnerd.space/wp-content/uploads/2017/01/MakerActionServiceIFTTT-150x150.png 150w, http://itnerd.space/wp-content/uploads/2017/01/MakerActionServiceIFTTT-300x300.png 300w, http://itnerd.space/wp-content/uploads/2017/01/MakerActionServiceIFTTT-30x30.png 30w, http://itnerd.space/wp-content/uploads/2017/01/MakerActionServiceIFTTT-100x100.png 100w, http://itnerd.space/wp-content/uploads/2017/01/MakerActionServiceIFTTT.png 310w" sizes="(max-width: 150px) 100vw, 150px" /><strong>Note:</strong> If you haven&#8217;t already, follow the steps in my <a href="http://itnerd.space/2017/01/22/how-to-control-your-tp-link-hs100-smartplug-from-internet/">previous post</a>, to figure out what yourÂ <em>Token</em> and <em>Device ID</em> are.</p>
<p>Then create a new <del>Recipe</del> Applet like you normally would in IFTTT, and choose the &#8220;<strong>Maker Webhook</strong> / Make a Web Request&#8221; action service to define a new action.</p>
<p>For the URL, I&#8217;ve used:</p>
<pre>https://eu-wap.tplinkcloud.com/?token=<span style="color: #800080;">YOUR_TOKEN_HERE</span></pre>
<p>and the method type is POST.</p>
<p><img data-attachment-id="308" data-permalink="http://itnerd.space/2017/01/22/control-your-tp-link-hs100-smart-plug-with-ifttt/error/" data-orig-file="http://itnerd.space/wp-content/uploads/2017/01/error.png" data-orig-size="512,512" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="error" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2017/01/error-300x300.png" data-large-file="http://itnerd.space/wp-content/uploads/2017/01/error.png" class="wp-image-308 alignleft" src="http://itnerd.space/wp-content/uploads/2017/01/error-150x150.png" alt="" width="38" height="38" srcset="http://itnerd.space/wp-content/uploads/2017/01/error-150x150.png 150w, http://itnerd.space/wp-content/uploads/2017/01/error-300x300.png 300w, http://itnerd.space/wp-content/uploads/2017/01/error-30x30.png 30w, http://itnerd.space/wp-content/uploads/2017/01/error.png 512w, http://itnerd.space/wp-content/uploads/2017/01/error-100x100.png 100w" sizes="(max-width: 38px) 100vw, 38px" /><strong>Note</strong>: For the URL: please read <a href="http://itnerd.space/2017/05/21/how-to-get-the-tp-link-hs100-cloud-end-point-url/">this other post</a>, as you might need to use a different URL depending the region where you are from.</p>
<p><a href="http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-45.png"><br />
</a> <a href="http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-27.png"><img data-attachment-id="211" data-permalink="http://itnerd.space/2017/01/22/control-your-tp-link-hs100-smart-plug-with-ifttt/screenshot-ifttt-com-2017-01-22-17-19-27/" data-orig-file="http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-27.png" data-orig-size="501,615" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="screenshot-ifttt.com-2017-01-22-17-19-27" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-27-244x300.png" data-large-file="http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-27.png" class="aligncenter wp-image-211 size-full" src="http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-27.png" width="501" height="615" srcset="http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-27.png 501w, http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-27-244x300.png 244w, http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-27-24x30.png 24w" sizes="(max-width: 501px) 100vw, 501px" /></a></p>
<p>The Content Type is application/json, and the payload to switch the plug On should be:</p>
<pre>{"method":"passthrough",
"params": {"deviceId": "<span style="color: #800080;">YOUR_DEVICEID_HERE</span>",
"requestData": "{\"system\":{\"set_relay_state\":{\"state\":<strong><span style="color: #339966;">1</span></strong>}
}
}" }
}</pre>
<p><img data-attachment-id="210" data-permalink="http://itnerd.space/2017/01/22/control-your-tp-link-hs100-smart-plug-with-ifttt/screenshot-ifttt-com-2017-01-22-17-19-45/" data-orig-file="http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-45.png" data-orig-size="440,471" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="screenshot-ifttt.com-2017-01-22-17-19-45" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-45-280x300.png" data-large-file="http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-45.png" class="aligncenter wp-image-210 size-full" src="http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-45.png" width="440" height="471" srcset="http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-45.png 440w, http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-45-280x300.png 280w, http://itnerd.space/wp-content/uploads/2017/01/screenshot-ifttt.com-2017-01-22-17-19-45-28x30.png 28w" sizes="(max-width: 440px) 100vw, 440px" /></p>
<p>If you want to switch the plug Off, just replace the state 1 with state 0.</p>
<p>Notice how I have added extra carriage returns to separate the &#8220;}&#8221; at the end, otherwise IFTTT was giving me some error.</p>
<p>That&#8217;s it! Easy, right?</p>
]]></content:encoded>
			<wfw:commentRss>http://itnerd.space/2017/01/22/control-your-tp-link-hs100-smart-plug-with-ifttt/feed/</wfw:commentRss>
		<slash:comments>27</slash:comments>
		</item>
		<item>
		<title>Azure App Service Architecture (4): Scalability</title>
		<link>http://itnerd.space/2016/11/13/azure-app-service-architecture-4-scalability/</link>
		<comments>http://itnerd.space/2016/11/13/azure-app-service-architecture-4-scalability/#respond</comments>
		<pubDate>Sun, 13 Nov 2016 20:21:10 +0000</pubDate>
		<dc:creator><![CDATA[Alex D.]]></dc:creator>
				<category><![CDATA[Cloud]]></category>
		<category><![CDATA[Architecture]]></category>
		<category><![CDATA[Azure]]></category>
		<category><![CDATA[PaaS]]></category>

		<guid isPermaLink="false">http://itnerd.space/?p=124</guid>
		<description><![CDATA[Azure App Service scalability: How do they do it? We usually understand well what scalability is, but how is it achieved technically?]]></description>
				<content:encoded><![CDATA[<blockquote><p><strong>Scalability</strong> is the capability of a system, network, or process to handle a growing amount of work, or its potential to be enlarged in order to accommodate that growth.</p></blockquote>
<p>Looking at scalability is very relevant in Cloud environment, which provide a high level of on demand elasticity and thus allow us to easily implement the scalability patterns most relevant to our applications to cater for our particular business needs, whichever they may be.</p>
<h3>App Service Plan Provisioning</h3>
<p>Let first have a look at what happen when you provision a new App Service Plan in Azure.</p>
<p>When you request the creation of an Azure Web App onto a new App Service Plan (aka. <em>Serverfarm</em>), Azure is not provisioning a brand new VM from scratch. Instead, I believe, they assign you a recycled VM of the chosen size, for example B1, from a pool of existing VM.</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning.png"><img data-attachment-id="116" data-permalink="http://itnerd.space/2016/11/13/azure-app-service-architecture-4-scalability/app-service-plan-provisioning/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning.png" data-orig-size="587,493" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="app-service-plan-provisioning" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-300x252.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning.png" class="size-full wp-image-116 aligncenter" src="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning.png" alt="app-service-plan-provisioning" width="587" height="493" srcset="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning.png 587w, http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-300x252.png 300w" sizes="(max-width: 587px) 100vw, 587px" /></a></p>
<p>Indeed you can see that by looking at the uptime of the provisioned VM instance (use Kudu advanced tools): uptime is quite random, and not near 0. A near 0 uptime would indicate a recently created VM. So, in my understanding, Azure keeps a pool of VMs just ready for when a new customer is requesting a new service plan, or when a scaling operation is needed.</p>
<p>That make a lot of sense. Provisioning a new VM each time would take quite a lot of time, while a new Web App deployment actually happens in about 15 to 20 seconds. For that purpose, I assume they will always keep a certain number of VMs ready in the pool, enough to respond to customer&#8217;s needs at all time in a timely manner.</p>
<h3>Horizontal scalability (Scale out / Scale in)</h3>
<p>Horizontal scalability is when you change the number of VM instances supporting your App Service Plan. When load on your apps grows, you will likely scale-out (add more VM instances). When the loads decrease, you will scale back in, reducing the number of VM instances.</p>
<p>As I understand it, when scaling-out, an operation similar to the provisioning will happen: Azure will assign you one new VM of the same size, from its pool of available VMs:</p>
<p style="text-align: center;"><a href="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Out.png"><img data-attachment-id="120" data-permalink="http://itnerd.space/2016/11/13/azure-app-service-architecture-4-scalability/app-service-plan-provisioning-scale-out/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Out.png" data-orig-size="579,498" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="app-service-plan-provisioning-scale-out" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Out-300x258.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Out.png" class="alignnone size-full wp-image-120" src="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Out.png" alt="app-service-plan-provisioning-scale-out" width="579" height="498" srcset="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Out.png 579w, http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Out-300x258.png 300w" sizes="(max-width: 579px) 100vw, 579px" /></a></p>
<p>When the plan scales back in again, the VM is removed from the Plan and placed back in the correspondin pool. As I understand it, it is recycled so it can be reused again, possibly by another customer.</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-In.png"><img data-attachment-id="119" data-permalink="http://itnerd.space/2016/11/13/azure-app-service-architecture-4-scalability/app-service-plan-provisioning-scale-in/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-In.png" data-orig-size="583,493" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="app-service-plan-provisioning-scale-in" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-In-300x254.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-In.png" class="size-full wp-image-119 aligncenter" src="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-In.png" alt="app-service-plan-provisioning-scale-in" width="583" height="493" srcset="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-In.png 583w, http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-In-300x254.png 300w" sizes="(max-width: 583px) 100vw, 583px" /></a></p>
<h3>Vertical scalability (Scale up/down)</h3>
<p>Vertical scalability is about changing the App Service Plan instance size. If you need more compute power to run you apps, you can choose to scale-up your plan to bigger VM(s). What happen in that case though?</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-1.png"><img data-attachment-id="118" data-permalink="http://itnerd.space/2016/11/13/azure-app-service-architecture-4-scalability/app-service-plan-provisioning-scale-up-1/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-1.png" data-orig-size="485,225" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="app-service-plan-provisioning-scale-up-1" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-1-300x139.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-1.png" class="size-full wp-image-118 aligncenter" src="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-1.png" alt="app-service-plan-provisioning-scale-up-1" width="485" height="225" srcset="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-1.png 485w, http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-1-300x139.png 300w" sizes="(max-width: 485px) 100vw, 485px" /></a><br />
AFAIK, Azure runs on Hyper-V virtualization platform, and at the time of this writing, Hyper-V doesn&#8217;t allow for dynamic CPU/RAM resizing of VMs. So how do they do it?</p>
<p>Well, I did the test on a Plan with a single small instance. I noticed the instance hostname and uptime before scaling up. I then scaled the plan up to medium, and guess what: the hostname and uptime of the only instance in the plan was totally different!</p>
<p>Here&#8217;s my educated guess: Azure assigned a medium VM from the pool of medium VM and added it to the Plan (1). All the Apps running in the plan started to run in that new VM as well. Only then, the small VM got removed from the Plan (2), leaving the plan with a single Medium VM.<br />
<a href="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-2.png"><img data-attachment-id="117" data-permalink="http://itnerd.space/2016/11/13/azure-app-service-architecture-4-scalability/app-service-plan-provisioning-scale-up-2/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-2.png" data-orig-size="642,369" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="app-service-plan-provisioning-scale-up-2" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-2-300x172.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-2.png" class="size-full wp-image-117 aligncenter" src="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-2.png" alt="app-service-plan-provisioning-scale-up-2" width="642" height="369" srcset="http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-2.png 642w, http://itnerd.space/wp-content/uploads/2016/11/App-Service-Plan-Provisioning-Scale-Up-2-300x172.png 300w" sizes="(max-width: 642px) 100vw, 642px" /></a><br />
We can also easily figure how it would happen with more than one VM. Scaling back in would also happen similarly.</p>
]]></content:encoded>
			<wfw:commentRss>http://itnerd.space/2016/11/13/azure-app-service-architecture-4-scalability/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Azure App Service Architecture (3): App Service on Linux</title>
		<link>http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/</link>
		<comments>http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/#comments</comments>
		<pubDate>Wed, 02 Nov 2016 20:24:53 +0000</pubDate>
		<dc:creator><![CDATA[Alex D.]]></dc:creator>
				<category><![CDATA[Cloud]]></category>
		<category><![CDATA[Linux]]></category>
		<category><![CDATA[Architecture]]></category>
		<category><![CDATA[Azure]]></category>
		<category><![CDATA[docker]]></category>
		<category><![CDATA[PaaS]]></category>

		<guid isPermaLink="false">http://itnerd.space/?p=82</guid>
		<description><![CDATA[Discover how Microsoft is leveraging Ubuntu and Docker to implement their new Azure PaaS offering: "App Service on Linux".]]></description>
				<content:encoded><![CDATA[<p>Until now, Azure customers could deploy their Web Applications running PHP, Node.js,&#8230; on Windows server running IIS, but now they will have a choice to run them on Linux: Microsoft recently announced the availability, in <em>Public Preview</em> mode, of <strong><a href="http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/">App Service on Linux</a></strong>:</p>
<blockquote><p><a href="http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/">App Service on Linux</a> is currently in Public Preview and enables customers to run their web apps natively on a Linux platform. This allows for better application compatibility for certain kinds of applications and makes it easier to migrate existing web apps hosted on a Linux platform elsewhere onto Azure App Services.</p></blockquote>
<p><span id="more-82"></span></p>
<p>In this third post in my series on Azure <a href="http://itnerd.space/?s=Azure+App+Service+Architecture">App Service Architecture</a>, I&#8217;ll focus on how Microsoft implemented this new Platform as a Service product. What will actually run your app if you deploy it on Linux, what Linux distribution they have chose, and how are all the apps deployed on those underlying Linux servers. If you haven&#8217;t read my preview two articles, I strongly recommend you read them first:Â <a href="http://itnerd.space/2016/10/28/azure-app-service-architecture-1/">Azure App Service Architecture (1)</a>Â andÂ <a href="http://itnerd.space/2016/10/29/azure-app-service-architecture-2/">Azure App Service Architecture (2)</a>Â as they will explain some basic concepts that are used in this one.</p>
<h1><strong>Provisioning a Web App on Linux</strong></h1>
<p>This part is really trivial. I&#8217;ll show some screenshots, but they are self explaining. Let&#8217;s click on the [+] button, and head to [Web + Mobile]. From there, we&#8217;ll select <strong>Web App on Linux (Preview)</strong>:</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_51_43-Choose-your-pricing-tier-Microsoft-Azure.png"><img data-attachment-id="78" data-permalink="http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/2016-11-02-13_51_43-choose-your-pricing-tier-microsoft-azure/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_51_43-Choose-your-pricing-tier-Microsoft-Azure.png" data-orig-size="696,765" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2016-11-02-13_51_43-choose-your-pricing-tier-microsoft-azure" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_51_43-Choose-your-pricing-tier-Microsoft-Azure-273x300.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_51_43-Choose-your-pricing-tier-Microsoft-Azure.png" class="alignnone size-full wp-image-78" src="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_51_43-Choose-your-pricing-tier-Microsoft-Azure.png" alt="2016-11-02-13_51_43-choose-your-pricing-tier-microsoft-azure" width="696" height="765" srcset="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_51_43-Choose-your-pricing-tier-Microsoft-Azure.png 696w, http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_51_43-Choose-your-pricing-tier-Microsoft-Azure-273x300.png 273w" sizes="(max-width: 696px) 100vw, 696px" /></a></p>
<p>I&#8217;ll set a new unique name for my new Web App:</p>
<p><img data-attachment-id="73" data-permalink="http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/2016-11-02-13_51_51-choose-your-pricing-tier-microsoft-azure/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_51_51-Choose-your-pricing-tier-Microsoft-Azure.png" data-orig-size="317,653" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2016-11-02-13_51_51-choose-your-pricing-tier-microsoft-azure" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_51_51-Choose-your-pricing-tier-Microsoft-Azure-146x300.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_51_51-Choose-your-pricing-tier-Microsoft-Azure.png" class="alignnone size-full wp-image-73" src="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_51_51-Choose-your-pricing-tier-Microsoft-Azure.png" alt="2016-11-02-13_51_51-choose-your-pricing-tier-microsoft-azure" width="317" height="653" srcset="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_51_51-Choose-your-pricing-tier-Microsoft-Azure.png 317w, http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_51_51-Choose-your-pricing-tier-Microsoft-Azure-146x300.png 146w" sizes="(max-width: 317px) 100vw, 317px" /></p>
<p>To be able to explore a little further the options available to us, I&#8217;ll choose to create a new App Service Plan, instead of using the default recommended to me. Notice that while the product is in Preview, it is not available in all Azure regions yet. In Europe it&#8217;s only available in West Europe for example. That&#8217;s enough for me to test it anyway.</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_13-Choose-your-pricing-tier-Microsoft-Azure.png"><img data-attachment-id="77" data-permalink="http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/2016-11-02-13_52_13-choose-your-pricing-tier-microsoft-azure/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_13-Choose-your-pricing-tier-Microsoft-Azure.png" data-orig-size="899,718" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2016-11-02-13_52_13-choose-your-pricing-tier-microsoft-azure" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_13-Choose-your-pricing-tier-Microsoft-Azure-300x240.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_13-Choose-your-pricing-tier-Microsoft-Azure.png" class="alignnone size-full wp-image-77" src="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_13-Choose-your-pricing-tier-Microsoft-Azure.png" alt="2016-11-02-13_52_13-choose-your-pricing-tier-microsoft-azure" width="899" height="718" srcset="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_13-Choose-your-pricing-tier-Microsoft-Azure.png 899w, http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_13-Choose-your-pricing-tier-Microsoft-Azure-300x240.png 300w, http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_13-Choose-your-pricing-tier-Microsoft-Azure-768x613.png 768w" sizes="(max-width: 899px) 100vw, 899px" /></a></p>
<p>Particularly, I don&#8217;t need to pay for a Standard plan, so I&#8217;ll choose a Basic B1 here.</p>
<p><img data-attachment-id="76" data-permalink="http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/2016-11-02-13_52_31-web-app-on-linux-preview-microsoft-azure/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_31-Web-App-On-Linux-preview-Microsoft-Azure.png" data-orig-size="317,718" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2016-11-02-13_52_31-web-app-on-linux-preview-microsoft-azure" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_31-Web-App-On-Linux-preview-Microsoft-Azure-132x300.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_31-Web-App-On-Linux-preview-Microsoft-Azure.png" class="alignnone size-full wp-image-76" src="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_31-Web-App-On-Linux-preview-Microsoft-Azure.png" alt="2016-11-02-13_52_31-web-app-on-linux-preview-microsoft-azure" width="317" height="718" srcset="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_31-Web-App-On-Linux-preview-Microsoft-Azure.png 317w, http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-13_52_31-Web-App-On-Linux-preview-Microsoft-Azure-132x300.png 132w" sizes="(max-width: 317px) 100vw, 317px" /></p>
<p>So here we go, just click the Create button, and in less than a minute, you&#8217;ll have a Web App up and running, ready for you to use to deploy your app, using your favorite Deployment method, Git, FTP&#8230;</p>
<h1><strong>App Service on Linux Architecture</strong></h1>
<p>To better understand what has been deployed by Azure, let&#8217;s head to the Development tools section of the Web App setting menu, and select Advanced Tools:</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-14_20_37-Advanced-Tools-Microsoft-Azure.png"><img data-attachment-id="84" data-permalink="http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/2016-11-02-14_20_37-advanced-tools-microsoft-azure/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-14_20_37-Advanced-Tools-Microsoft-Azure.png" data-orig-size="647,447" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2016-11-02-14_20_37-advanced-tools-microsoft-azure" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-14_20_37-Advanced-Tools-Microsoft-Azure-300x207.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-14_20_37-Advanced-Tools-Microsoft-Azure.png" class="alignnone size-full wp-image-84" src="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-14_20_37-Advanced-Tools-Microsoft-Azure.png" alt="2016-11-02-14_20_37-advanced-tools-microsoft-azure" width="647" height="447" srcset="http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-14_20_37-Advanced-Tools-Microsoft-Azure.png 647w, http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-14_20_37-Advanced-Tools-Microsoft-Azure-300x207.png 300w, http://itnerd.space/wp-content/uploads/2016/11/2016-11-02-14_20_37-Advanced-Tools-Microsoft-Azure-230x160.png 230w" sizes="(max-width: 647px) 100vw, 647px" /></a></p>
<p>Then click on the Go link. It will open the traditional Kudu tools console, where we will have access to some internal information regarding our Web App.</p>
<h2>Application layer</h2>
<p>First let&#8217;s figure out what we have at the Application layer. That is, what kind of software is going to serve our application. In this case, from the Environment tab, we canÂ see some interesting Server Environment Variables:</p>
<pre>SERVER_SOFTWARE=Apache/2.4.10 (Debian)</pre>
<p>So apparently the Web App is deployed on <strong>Apache 2.4 </strong>on<strong> Debian</strong>.</p>
<p>Let&#8217;s dig a little deeper with the Bash console, and have a look at the processes we can see:</p>
<pre>Kudu Remote Execution Console
Type 'exit' to reset this console.
/home&gt; ps -ef
UID PID PPID C STIME TTY TIME CMD
1001 1 0 0 12:54 ? 00:00:00 /bin/sh -c /usr/sbin/apache2ctl -D FOREGROUND
1001 5 1 0 12:54 ? 00:00:00 /bin/sh /usr/sbin/apache2ctl -D FOREGROUND
1001 7 5 0 12:54 ? 00:00:00 /usr/sbin/apache2 -D FOREGROUND
1001 9 1 0 12:54 ? 00:00:00 /usr/bin/mono /usr/lib/mono/4.5/mod-mono-server4.exe --filename /tmp/.mod_mono_server4 --nonstop --appconfigdir /etc/mono-server4
1001 12 7 0 12:54 ? 00:00:00 /usr/sbin/apache2 -D FOREGROUND
1001 13 7 0 12:54 ? 00:00:00 /usr/sbin/apache2 -D FOREGROUND
1001 71 1 6 12:54 ? 00:00:08 /usr/bin/mono /usr/lib/mono/4.5/mod-mono-server4.exe --filename /tmp/mod_mono_server_default --applications /:/opt/Kudu --nonstop
1001 126 71 0 12:56 ? 00:00:00 /bin/bash -c ps -ef &amp;&amp; echo &amp;&amp; pwd
1001 127 126 0 12:56 ? 00:00:00 ps -ef</pre>
<p>We can see very few processes running, and especially interesting, the PID 1 is apache2ctl, so we are most likely running is a container (if we were in a full server, it would be &#8220;init&#8221;). All the processes run as a non-root user (uid 1001).</p>
<p>We can indeed confirm that our Web App is running inside a Docker container by looking at /proc/1/cgroup:</p>
<pre>/home&gt; cat /proc/1/cgroup
11:memory:<strong>/docker/</strong>fb05a97d54930566111197c8959a5a33ac9af29b6491bf1ca8158b18df50264b
10:cpuset:/docker/fb05a97d54930566111197c8959a5a33ac9af29b6491bf1ca8158b18df50264b
9:hugetlb:/docker/fb05a97d54930566111197c8959a5a33ac9af29b6491bf1ca8158b18df50264b
8:blkio:/docker/fb05a97d54930566111197c8959a5a33ac9af29b6491bf1ca8158b18df50264b
7:perf_event:/docker/fb05a97d54930566111197c8959a5a33ac9af29b6491bf1ca8158b18df50264b
6:net_cls,net_prio:/docker/fb05a97d54930566111197c8959a5a33ac9af29b6491bf1ca8158b18df50264b
5:pids:/docker/fb05a97d54930566111197c8959a5a33ac9af29b6491bf1ca8158b18df50264b
4:cpu,cpuacct:/docker/fb05a97d54930566111197c8959a5a33ac9af29b6491bf1ca8158b18df50264b
3:freezer:/docker/fb05a97d54930566111197c8959a5a33ac9af29b6491bf1ca8158b18df50264b
2:devices:/docker/fb05a97d54930566111197c8959a5a33ac9af29b6491bf1ca8158b18df50264b
1:name=systemd:/docker/fb05a97d54930566111197c8959a5a33ac9af29b6491bf1ca8158b18df50264b</pre>
<p>So, Web App on Linux are deployed in <strong>Docker containers</strong> (and we know the ID of the container in the host).</p>
<p>Unfortunately, there&#8217;s not much we can do from inside the Docker container itself to guess anything about the host running the Docker engine, so we don&#8217;t really know what is the OS flavor, version or anything else.</p>
<p>We can have a look at the kernel, which is shared between the VM (host) and all the containers run in the same VM:</p>
<pre class="jquery-console-prompt-box"><span class="jquery-console-prompt-label">/home&gt;</span><span class="jquery-console-prompt">Â unameÂ -a</span>
Linux e30a13645e09 4.4.0-45-generic #66-Ubuntu SMP Wed Oct 19 14:12:37 UTC 2016 x86_64 GNU/Linux</pre>
<div class="jquery-console-message jquery-console-message-value">So it looks like it it might be some version of Ubuntu, likely 16.04 (Xenial), whereÂ 4.4.0-45-generic #66 is available (<del>although it could also be 14.04</del>). Confirmed by Nalim, Software Engineer at Microsoft, they are using Ubuntu 16.04 for the hosts (VM instances), see comments below.</div>
<p>Regarding the Docker image that was used, we can see it&#8217;s based on <strong>Debian 8 (Jessie)</strong>:</p>
<pre>/home&gt; cat /etc/os-release
PRETTY_NAME="Debian GNU/Linux 8 (jessie)"
NAME="Debian GNU/Linux"
VERSION_ID="8"
VERSION="8 (jessie)"
ID=debian
HOME_URL="http://www.debian.org/"
SUPPORT_URL="http://www.debian.org/support"
BUG_REPORT_URL="https://bugs.debian.org/"</pre>
<h2><strong>Data layer: Persistent Storage?</strong></h2>
<p>Storage inside a Docker container is, usually, volatile, but if we deploy our App there, we don&#8217;t want to loose it when the container stops or the host reboots. Also, we want to be able to scale out our Web App when load increase. So we require some kind of persistency!</p>
<p>Similarly to Web App on Windows, where the persisted files are found in D:\home, here we&#8217;ll store the Persisted files in /home. As this Web App is recently created, it&#8217;s actually quite empty right now:</p>
<pre class="jquery-console-prompt-box"><span class="jquery-console-prompt-label">/home&gt;</span><span class="jquery-console-prompt">pwd
</span>/home
<span class="jquery-console-prompt-label">/home&gt;</span><span class="jquery-console-prompt">ls</span>
LogFiles site</pre>
<p>So how is the storage actually persisted?</p>
<pre>/home&gt; mount | grep /home
//10.0.176.8/volume-46-default/20a35f31f26928286ecf/580efcc549c040228b254d82ab4ed6e1 on /home type cifs (rw,relatime,vers=3.0,sec=ntlmssp,cache=strict,username=dummyadmin,domain=RD0003FF1A594C,uid=1001,forceuid,gid=1002,forcegid,addr=10.0.176.8,file_mode=0700,dir_mode=0700,nounix,serverino,mapposix,mfsymlinks,rsize=1048576,wsize=1048576,actimeo=1)</pre>
<p>We can see that the /home directory is actually a network shared volume mounted via CIFS protocol (I can only assume here it&#8217;s backed by Azure Storage). That way Azure will be able to scale out our Web App, deploying more containers based on the very same <em>stateless image</em>, mounting the same volume which is where our Web App files are deployed.</p>
<p><del>I think Microsoft might be using here a custom implementation of theirÂ <a title="" href="https://github.com/Azure/azurefile-dockervolumedriver">Docker Volume Plugin for Azure File Storage</a>. (I haven&#8217;t had time yet to play with it and see how similar (or not) things look with this Docker storage plugin).</del>Â For the persistent storage, Microsoft is using Fileservers that export SMB shares mounted in the host. Those are then mapped as /home into the corresponding docker containers.</p>
<p><strong>Putting everything together</strong></p>
<p>Let step back now. This is how I see Microsoft implemented <a href="http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/">App Service on Linux</a>. First when we only deploy 1 web app on a single instance:</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_20_12-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png"><img data-attachment-id="101" data-permalink="http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/2016-11-04-12_20_12-azure_app_services-architecture-vsd-microsoft-visio/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_20_12-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png" data-orig-size="380,676" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Azure App Service Architecture on Linux (single App &#038; Instance)" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_20_12-Azure_App_Services-Architecture.vsd-Microsoft-Visio-169x300.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_20_12-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png" class="size-full wp-image-101 aligncenter" src="http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_20_12-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png" alt="Azure App Service Architecture on Linux (single App &amp; Instance)" width="380" height="676" srcset="http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_20_12-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png 380w, http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_20_12-Azure_App_Services-Architecture.vsd-Microsoft-Visio-169x300.png 169w" sizes="(max-width: 380px) 100vw, 380px" /></a></p>
<p>Now, how does it look likes if we deploy multiple Web Apps in the same plan, and we scale out the Plan to two instances?</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_30_15-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png"><img data-attachment-id="105" data-permalink="http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/2016-11-04-12_30_15-azure_app_services-architecture-vsd-microsoft-visio/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_30_15-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png" data-orig-size="1045,649" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Azure App Service Architecture on Linux (multiple Apps &#038; Instances)" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_30_15-Azure_App_Services-Architecture.vsd-Microsoft-Visio-300x186.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_30_15-Azure_App_Services-Architecture.vsd-Microsoft-Visio-1024x636.png" class="alignnone size-full wp-image-105" src="http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_30_15-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png" alt="Azure App Service Architecture on Linux (multiple Apps &amp; Instances)" width="1045" height="649" srcset="http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_30_15-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png 1045w, http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_30_15-Azure_App_Services-Architecture.vsd-Microsoft-Visio-300x186.png 300w, http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_30_15-Azure_App_Services-Architecture.vsd-Microsoft-Visio-768x477.png 768w, http://itnerd.space/wp-content/uploads/2016/11/2016-11-04-12_30_15-Azure_App_Services-Architecture.vsd-Microsoft-Visio-1024x636.png 1024w" sizes="(max-width: 1045px) 100vw, 1045px" /></a></p>
<p>I hope this gave you a good understanding of how Microsoft implemented internally this new <a href="http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/">App Service on Linux</a> product.</p>
]]></content:encoded>
			<wfw:commentRss>http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		</item>
		<item>
		<title>Azure App Service Architecture (2)</title>
		<link>http://itnerd.space/2016/10/29/azure-app-service-architecture-2/</link>
		<comments>http://itnerd.space/2016/10/29/azure-app-service-architecture-2/#comments</comments>
		<pubDate>Sat, 29 Oct 2016 17:34:21 +0000</pubDate>
		<dc:creator><![CDATA[Alex D.]]></dc:creator>
				<category><![CDATA[Cloud]]></category>
		<category><![CDATA[Architecture]]></category>
		<category><![CDATA[Azure]]></category>
		<category><![CDATA[PaaS]]></category>

		<guid isPermaLink="false">http://itnerd.space/?p=47</guid>
		<description><![CDATA[This is the second post of a series, on Azure App Service Architecture. TheÂ first oneÂ introduced the concepts of App and Plan, what are the Pricing Tiers and Instance Sizes. This oneÂ will give some more details on how I understand the service plan are architected internally.After working with Azure webapps and&#8230; ]]></description>
				<content:encoded><![CDATA[<p><em>This is the second post of a series, on Azure <a href="http://itnerd.space/?s=Azure+App+Service+Architecture">App Service Architecture</a>. TheÂ <a href="/2016/10/28/azure-app-service-architecture-1/">first one</a>Â introduced the concepts of App and Plan, what are the Pricing Tiers and Instance Sizes. This oneÂ will give some more details on how I understand the service plan are architected internally.</em><span id="more-47"></span>After working with Azure webapps and looking for more detailed information of how they are implemented in Azure, this is my understanding of how Azure App Services solution isÂ architected internally.</p>
<p><em><strong>Note</strong>: This article is based solely on information gathered from publicly available sources, mainly Microsoft Azure documentation site and Github, wrapped with my own understanding and conclusions.</em></p>
<p>Let&#8217;s have a look at what an App Service Plan is actually made of.</p>
<p><strong>Compute</strong></p>
<p>We&#8217;ve seen in the first post that the App Service Plan is formed of one or more VMs instances (which can be dedicated or shared depending on the Service Tier). Also we&#8217;ve seen you can deploy multiple apps to the same Plan. The apps will then all run on all the instances of the Plan.</p>
<p>Inside each VM Instance of the Plan, you Apps are deployed in Sandboxes:</p>
<ul>
<li><strong>Sandbox mechanism</strong></li>
</ul>
<p>Azure App Services run in a secure environment called aÂ sandbox. Each app runs inside its own sandbox, isolating its execution from other instances on the same machine as well as providing an additional degree of security and privacy.</p>
<p>The sandbox mechanism mitigates the risk of service disruption due to resource contention and depletion in two ways: it ensures that each app receives a minimum guarantee of resources and quality-of-service, and conversely enforces limits so that an app can not disrupt other concurrently-executing apps on the same machine.</p>
<p><strong>Storage</strong></p>
<p>From a storage perspective, and especially when it comes to scale-out (horizontally), it comes handy to understand what are the storage capabilities available to an App deployed in an App Service Plan. There are two kinds: Temporary storage, and Persisted storage.</p>
<ul>
<li><strong>Temporary files</strong></li>
</ul>
<p>Whithin the context of the Application deployed in the WebApp, a number of common Windows locations are using temporary storage on the local machine. For instance:</p>
<p>%APPDATA% points to something like D:\local\AppData.<br />
%TMP% goes to D:\local\Temp.</p>
<p>Unlike Persisted files, these files are not shared among site instances. Also, you cannot rely on them staying there. For instance, if you stop a site and restart it, you&#8217;ll find that all of these folders get reset to their original state.</p>
<ul>
<li><strong>Persisted files</strong></li>
</ul>
<p>Every Azure Web App has a home directory stored/backed by Azure Storage. This network share is where applications store their content. The sandbox implements a dynamic symbolic link in kernel mode which mapsÂ d:\homeÂ to the customer home directory.</p>
<p>These files are shared between all instances of your site (when you scale it up to multiple instances). Internally, the way this works is that they are stored in Azure Storage instead of living on the local file system. They are rooted in d:\home, which can also be found using the %HOME% environment variable.</p>
<p><strong><a href="http://itnerd.space/?s=Azure+App+Service+Architecture">App Service Architecture</a></strong></p>
<p>Now if we put everything together, let&#8217;s have a look at how it looks. First let&#8217;s start with a single App deployed on a Service Plan with a single VM Instance:</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app1instance.png"><img data-attachment-id="41" data-permalink="http://itnerd.space/2016/10/28/azure-app-service-architecture-1/azure-app-service-plan-1app1instance/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app1instance.png" data-orig-size="197,476" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="azure-app-service-plan-1app1instance" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app1instance-124x300.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app1instance.png" class="size-full wp-image-41 aligncenter" src="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app1instance.png" alt="azure-app-service-plan-1app1instance" width="197" height="476" srcset="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app1instance.png 197w, http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app1instance-124x300.png 124w" sizes="(max-width: 197px) 100vw, 197px" /></a></p>
<p>Now let&#8217;s see how it looks when we scale-out the plan to two VM instances. We can see how each instance of the App will have a separate Temporary storage in each VM, while they share the Persisted storage (where the App files are deployed).</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app2instance.png"><img data-attachment-id="40" data-permalink="http://itnerd.space/2016/10/28/azure-app-service-architecture-1/azure-app-service-plan-1app2instance/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app2instance.png" data-orig-size="379,476" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="azure-app-service-plan-1app2instance" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app2instance-239x300.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app2instance.png" class="size-full wp-image-40 aligncenter" src="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app2instance.png" alt="azure-app-service-plan-1app2instance" width="379" height="476" srcset="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app2instance.png 379w, http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-1app2instance-239x300.png 239w" sizes="(max-width: 379px) 100vw, 379px" /></a></p>
<p>&nbsp;</p>
<p>How does it look if we now deploy multiple Apps to this same App Service Plan?</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-3app2instance.png"><img data-attachment-id="39" data-permalink="http://itnerd.space/2016/10/28/azure-app-service-architecture-1/azure-app-service-plan-3app2instance/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-3app2instance.png" data-orig-size="795,480" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="azure-app-service-plan-3app2instance" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-3app2instance-300x181.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-3app2instance.png" class="size-full wp-image-39 aligncenter" src="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-3app2instance.png" alt="azure-app-service-plan-3app2instance" width="795" height="480" srcset="http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-3app2instance.png 795w, http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-3app2instance-300x181.png 300w, http://itnerd.space/wp-content/uploads/2016/10/Azure-App-Service-Plan-3app2instance-768x464.png 768w" sizes="(max-width: 795px) 100vw, 795px" /></a></p>
<p>Notice how within its sandbox, every App in a same VM will keep seeing it&#8217;s persisted storage as D:\home, and the Temporary storage as D:\local. That&#8217;s quite nice!</p>
<p><strong>Console Access</strong></p>
<p>From Azure Portal you can access the App&#8217;s console: the Kudu tools give access to the Web site app at the sandbox level. From there you can access D:\local and D:\home. The hostname command shows the hostname of the VM (ie. the instance where the console is being connected to).</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/10/asp_console_access.png"><img data-attachment-id="51" data-permalink="http://itnerd.space/2016/10/29/azure-app-service-architecture-2/asp_console_access/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/10/asp_console_access.png" data-orig-size="1073,480" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="asp_console_access" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/10/asp_console_access-300x134.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/10/asp_console_access-1024x458.png" class="alignnone wp-image-51" src="http://itnerd.space/wp-content/uploads/2016/10/asp_console_access.png" alt="asp_console_access" width="865" height="387" srcset="http://itnerd.space/wp-content/uploads/2016/10/asp_console_access.png 1073w, http://itnerd.space/wp-content/uploads/2016/10/asp_console_access-300x134.png 300w, http://itnerd.space/wp-content/uploads/2016/10/asp_console_access-768x344.png 768w, http://itnerd.space/wp-content/uploads/2016/10/asp_console_access-1024x458.png 1024w, http://itnerd.space/wp-content/uploads/2016/10/asp_console_access-670x300.png 670w" sizes="(max-width: 865px) 100vw, 865px" /></a></p>
]]></content:encoded>
			<wfw:commentRss>http://itnerd.space/2016/10/29/azure-app-service-architecture-2/feed/</wfw:commentRss>
		<slash:comments>3</slash:comments>
		</item>
		<item>
		<title>Azure App Service Architecture (1)</title>
		<link>http://itnerd.space/2016/10/28/azure-app-service-architecture-1/</link>
		<comments>http://itnerd.space/2016/10/28/azure-app-service-architecture-1/#respond</comments>
		<pubDate>Fri, 28 Oct 2016 13:16:50 +0000</pubDate>
		<dc:creator><![CDATA[Alex D.]]></dc:creator>
				<category><![CDATA[Cloud]]></category>
		<category><![CDATA[Architecture]]></category>
		<category><![CDATA[Azure]]></category>
		<category><![CDATA[PaaS]]></category>

		<guid isPermaLink="false">http://itnerd.space/?p=38</guid>
		<description><![CDATA[This is the first post of a series on Azure App Service Architecture. This one introduces the concepts of Apps, and Plans, what are the Pricing Tiers and Instance Sizes. TheÂ second postÂ willÂ give some more details on how I understand the service plan are architected. The 3rd post looks at how&#8230; ]]></description>
				<content:encoded><![CDATA[<p><em>This is the first post of a series on Azure <a href="http://itnerd.space/?s=Azure+App+Service+Architecture">App Service Architecture</a>. This one introduces the concepts of Apps, and Plans, what are the Pricing Tiers and Instance Sizes. TheÂ </em><a href="http://itnerd.space/2016/10/29/azure-app-service-architecture-2/">second post</a><em>Â willÂ give some more details on how I understand the service plan are architected. The 3rd post looks at how Microsoft implementedÂ <a href="http://itnerd.space/2016/11/02/azure-app-service-architecture-3-app-service-on-linux/">App Service on Linux</a>.</em></p>
<p>Azure App Services is a Platform-as-a-Service (PaaS) cloud service offering by MicrosoftÂ focused on providing superior developer productivity without compromising on the need to deliver applications at cloud scale. It also provides the features and frameworks necessary to compose enterprise applications while supporting developers with the most popular development languages (.NET, Java, PHP, Node.JS and Python). With App Service developers can:</p>
<ul>
<li>Build highly scalable Web Apps</li>
<li>Quickly build Mobile App back-ends with a set of easy to use mobile capabilities such as data back-ends, user authentication and push notifications with Mobile Apps.</li>
<li>Implement, deploy and publish APIs with API Apps.</li>
<li>Tie business applications together into workflows and transform data with Logic Apps.</li>
</ul>
<p><img data-attachment-id="43" data-permalink="http://itnerd.space/2016/10/28/azure-app-service-architecture-1/2016-10-28-14_26_33-app-service-documentation-_-azure/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_26_33-App-Service-Documentation-_-Azure.png" data-orig-size="895,178" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="App Services available on Azure" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_26_33-App-Service-Documentation-_-Azure-300x60.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_26_33-App-Service-Documentation-_-Azure.png" class="aligncenter wp-image-43 size-full" title="App Services available on Azure" src="http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_26_33-App-Service-Documentation-_-Azure.png" alt="App Services available on Azure" width="895" height="178" srcset="http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_26_33-App-Service-Documentation-_-Azure.png 895w, http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_26_33-App-Service-Documentation-_-Azure-300x60.png 300w, http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_26_33-App-Service-Documentation-_-Azure-768x153.png 768w" sizes="(max-width: 895px) 100vw, 895px" /></p>
<p>To be able to deploy any App on Azure App Service you&#8217;ll need an App Service Plan:</p>
<p><strong>App Service Plans</strong></p>
<p>An App Service Plan represents a set of features and capacity (compute, storage) that you can share across multiple apps. in Azure you deploy a Web App on an App Service Plan, which is formed of one or more (VM) Instance.</p>
<p>App Service Plans are specified by two characteristics:</p>
<ul>
<li>The Pricing Tier: from <em>Free</em>, <em>Shared</em>, <em>Basic</em>, <em>Standard</em> to <em>Premium</em></li>
<li>The Instance Size: fromÂ <em>Small</em>, <em>Medium</em>, <em>Large</em>Â to <em>Extra Large</em></li>
</ul>
<p>The Instance sizes define some compute and storage characteristics of the underlying VM instances that will form the App Service Plan. The CPU and Ram is the same for every Pricing Tier (Basic, Standard or Premium. In Free or Shared you can&#8217;t select the Instance Size). Here are the size available at the time of this writing:</p>
<p><img data-attachment-id="44" data-permalink="http://itnerd.space/2016/10/28/azure-app-service-architecture-1/asp_instancesizes/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/10/ASP_InstanceSizes.png" data-orig-size="905,215" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Instance Sizes" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/10/ASP_InstanceSizes-300x71.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/10/ASP_InstanceSizes.png" class="aligncenter wp-image-44" src="http://itnerd.space/wp-content/uploads/2016/10/ASP_InstanceSizes.png" alt="Instance Sizes" width="497" height="118" srcset="http://itnerd.space/wp-content/uploads/2016/10/ASP_InstanceSizes.png 905w, http://itnerd.space/wp-content/uploads/2016/10/ASP_InstanceSizes-300x71.png 300w, http://itnerd.space/wp-content/uploads/2016/10/ASP_InstanceSizes-768x182.png 768w" sizes="(max-width: 497px) 100vw, 497px" /></p>
<p>The Pricing Tier define some other capacity characteristics as well as features and services that will be available to the App that we deploy in the Plan.</p>
<p><img data-attachment-id="45" data-permalink="http://itnerd.space/2016/10/28/azure-app-service-architecture-1/asp_tiersfeatures/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/10/ASP_TiersFeatures.png" data-orig-size="709,278" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="asp_tiersfeatures" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/10/ASP_TiersFeatures-300x118.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/10/ASP_TiersFeatures.png" class="aligncenter wp-image-45 size-full" src="http://itnerd.space/wp-content/uploads/2016/10/ASP_TiersFeatures.png" alt="asp_tiersfeatures" width="709" height="278" srcset="http://itnerd.space/wp-content/uploads/2016/10/ASP_TiersFeatures.png 709w, http://itnerd.space/wp-content/uploads/2016/10/ASP_TiersFeatures-300x118.png 300w" sizes="(max-width: 709px) 100vw, 709px" /></p>
<p>Note that in theÂ <em>Free</em> andÂ <em>Shared</em> tier, the VM Instances are shared in a multitenant fashion (possibly with other customers), while fromÂ <em>Basic</em> toÂ <em>Premium </em>tiers, the VM Instances are dedicated.</p>
<p>Internally (in API documentation,&#8230;), App Service Plan are actually called &#8220;hosting Plan&#8221; or &#8220;serverFarm&#8221;, which reveal the true nature of what they really are.</p>
<p><strong>Deployment model</strong></p>
<p>From a deployment perspective, Apps in the same subscription and geographic location can share a plan. All the apps that share a plan can use all the capabilities and features that are defined by the plan&#8217;s tier. All apps that are associated with a plan run on the resources (VM Instances) that the plan defines:</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_23_33-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png"><img data-attachment-id="42" data-permalink="http://itnerd.space/2016/10/28/azure-app-service-architecture-1/2016-10-28-14_23_33-azure_app_services-architecture-vsd-microsoft-visio/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_23_33-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png" data-orig-size="415,277" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Azure App Service Deployment model" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_23_33-Azure_App_Services-Architecture.vsd-Microsoft-Visio-300x200.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_23_33-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png" class="aligncenter wp-image-42 size-full" src="http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_23_33-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png" alt="Azure App Service Deployment model" width="415" height="277" srcset="http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_23_33-Azure_App_Services-Architecture.vsd-Microsoft-Visio.png 415w, http://itnerd.space/wp-content/uploads/2016/10/2016-10-28-14_23_33-Azure_App_Services-Architecture.vsd-Microsoft-Visio-300x200.png 300w" sizes="(max-width: 415px) 100vw, 415px" /></a></p>
<p><strong>Scalability Up &amp; Out</strong></p>
<p>Scalability of the App Service Plan is achieve either horizontally by adding more VM Instances to the Plan (Scale-Out), or vertically, by changing to Â a larger Instance Size (Scale-Up).</p>
<p>Scaling-Up is a manual action, which occurs without service impact. Scaling-Out can be done manually, scheduled to happen periodically, or automated based on some performance metrics (from the Plan itself, or other resources like the Storage, Service Bus,&#8230;).</p>
<p>I&#8217;ve dedicated a whole post to how Azure achieves Scalability of the App Service Plans.</p>
<p><em>Watch out for myÂ </em><a href="http://itnerd.space/2016/10/29/azure-app-service-architecture-2/">next post</a><em>Â where I&#8217;ll explain how AppÂ Service Plans are architected internally.</em></p>
]]></content:encoded>
			<wfw:commentRss>http://itnerd.space/2016/10/28/azure-app-service-architecture-1/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Offsite Linux backup to Mega with duplicity</title>
		<link>http://itnerd.space/2016/10/26/offsite-backup-with-duplicity-and-mega/</link>
		<comments>http://itnerd.space/2016/10/26/offsite-backup-with-duplicity-and-mega/#respond</comments>
		<pubDate>Wed, 26 Oct 2016 23:22:10 +0000</pubDate>
		<dc:creator><![CDATA[Alex D.]]></dc:creator>
				<category><![CDATA[Cloud]]></category>
		<category><![CDATA[How-to]]></category>
		<category><![CDATA[Linux]]></category>
		<category><![CDATA[backup]]></category>
		<category><![CDATA[cloud]]></category>
		<category><![CDATA[docker]]></category>
		<category><![CDATA[duplicity]]></category>
		<category><![CDATA[mega]]></category>

		<guid isPermaLink="false">http://itnerd.space/?p=7</guid>
		<description><![CDATA[This is about a small personal initiative: I was looking for a solution to backup some Linux servers that I have, at home and in the cloud. Ideally, my requirements were: Backup should be offsite, preferably in the cloud Solution should support some kind of backup policies (full, incremental, and&#8230; ]]></description>
				<content:encoded><![CDATA[<p>This is about a small personal initiative: I was looking for a solution to backup some Linux servers that I have, at home and in the cloud.</p>
<p>Ideally, my requirements were:</p>
<ul>
<li>Backup should be offsite, preferably in the cloud</li>
<li>Solution should support some kind of backup policies (full, incremental, and retention time)</li>
<li>Solution should be secure, so support encryption</li>
<li>Solution should be portable, so same solution would play nicely with the servers, not mess with their OS (dependencies,&#8230;)</li>
<li>Solution should be as cheap as possible (or ideally free!)</li>
</ul>
<p><span id="more-7"></span></p>
<p>For the offsite storage I first though of using AWS Glacier, a cloud storage meant for cold data that you archive, and don&#8217;t need to retrieve often, but the cost was not so cheap. While storage in itself was not too expensive, the cost of retrieving the data (in case you want to restore, which is the point of having a backup, right?), was kind of prohibitive (for the budget I had in mind). So I started to look for alternatives.</p>
<p>For the backup solution, I wanted to use <a href="http://duplicity.nongnu.org/" target="_blank">duplicity</a>. Duplicity supports full and incremental backups, using the rsync protocol, and have support for a lot of storage backend: file, FTP, SSH, AWS S3, Azure, Dropbox, OneDrive, Mega,&#8230; Most of those backends are either illimited but paid services, or free but rather limited (in capacity) storage. All but Mega, which offer for free 50GB of storage, which is quite nice for backup purpose. Perfect fit in my case.</p>
<p>Regarding the portability requirement, I love Docker containers, and all I deploy now for my personal projects is Dockerized. This wasn&#8217;t going to be an exception. Especially I&#8217;d hate to install all kind of dependencies for duplicity and the storage backend plugins in all my servers!</p>
<p>So Docker it would be.</p>
<p>Now back to the storage layer in our solution: although duplicity supposedly have support for a Mega backend, it seems Mega changed their API/SDK, and the current plugin is not working anymore, and would need to be reworked totally. So as an alternative, I turned to using MegaFuse, a Fuse module to mount Mega storage in Linux: so the idea is we first mount the Mega account as a filesystem in Linux, and then we use it as destination of our backup with duplicity (using the file backend). Not as cool as having duplicity talk directly to Mega, but that seems to work equally.</p>
<p>So to recap, we have a container with duplicity and MegaFuse. As the container is stateless, we&#8217;ll map some volumes from the host to the container so the container gets the needed information:</p>
<ul>
<li>/vol/dupmega/megafuse.conf, containing some config for MegaFuse, like the credentials to the Mega account (see below),</li>
<li>As duplicity and MegaFuse both keep a local cache with some metadata, having those stored in the container would do no good, so I also put that in host mapped folder (/vol/dupmega/cache/duplicity/ and /vol/dupmega/cache/megafuse/)</li>
<li>Of course, we want to backup the host, not the container, so we need to map that as well into the container to /source</li>
</ul>
<p>The megafuse.conf contains:</p>
<p><code>USERNAME = username@domain.com<br />
PASSWORD = aV3ryComplexMegaP4ssw0rd<br />
MOUNTPOINT = /mega<br />
CACHEPATH = /dupmega/cache/megafuse<br />
</code><br />
So the Mega account is mounted in /mega in the container, and the MegaFuse cache will be in /dupmega/cache/megafuse (host mounted volume).</p>
<p>Here is the Dockerfile I have used to create my duplicity container with MegaFuse support. Right now it&#8217;s not yet published to Docker Hub. Right now it&#8217;s very rudimentary, there&#8217;s not even a CMD.</p>
<p><code>FROM ubuntu:14.04<br />
MAINTAINER Alexandre Dumont &lt;adumont@gmail.com&gt;</code></p>
<p>ENV DEBIAN_FRONTEND=noninteractive</p>
<p>RUN sed -i -e &#8216;/^deb-src/ s/^/#/&#8217; /etc/apt/sources.list &amp;&amp; \<br />
echo &#8220;force-unsafe-io&#8221; &gt; /etc/dpkg/dpkg.cfg.d/02apt-speedup &amp;&amp; \<br />
echo &#8220;Acquire::http {No-Cache=True;};&#8221; &gt; /etc/apt/apt.conf.d/no-cache &amp;&amp; \<br />
apt-get update &amp;&amp; \<br />
apt-get -qy dist-upgrade &amp;&amp; \<br />
apt-get install -y libcrypto++-dev libcurl4-openssl-dev libfreeimage-dev libreadline-dev libfuse-dev libdb++-dev duplicity git g++ make &amp;&amp; \<br />
apt-get clean &amp;&amp; \<br />
rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* &amp;&amp; \<br />
git clone https://github.com/matteoserva/MegaFuse &amp;&amp; \<br />
cd MegaFuse &amp;&amp; \<br />
make</p>
<p>I use the following command to build the image:</p>
<p><code>docker build -t adumont/dupmega --no-cache=true .</code></p>
<p>And here&#8217;s the image:</p>
<p><code>REPOSITORY TAG IMAGE ID CREATED SIZE<br />
adumont/dupmega latest 3bf1d313aa56 7 days ago 581.8 MB<br />
</code></p>
<p>I still have to work on simplifying the whole process of running a backup. For now, I do it rather manually, but it will become a script and be scheduled in cron most likely.</p>
<p>Right now that&#8217;s how I run it, notice the volume mapping from host to containers. Also notice the container has to run as privileged, so it can use Fuse from inside the container. The source to be backed up is mounted read-only (least privilege).</p>
<p><code>host# docker run --rm -h $( hostname ) -ti --privileged \<br />
-v /vol/dupmega:/dupmega \<br />
-v /root/.gnupg:/root/.gnupg \<br />
-v /vol/dupmega/cache/duplicity:/root/.cache/duplicity \<br />
-v /:/source:ro adumont/dupmega<br />
</code></p>
<p>Then from inside the container, I run:</p>
<p><code>mkdir /mega; MegaFuse/MegaFuse -c /dupmega/megafuse.conf &amp;&gt;/dev/null &amp;<br />
sleep 10<br />
[ -d /mega/backups/$(hostname) ] || exit 1</p>
<p>export PASSPHRASE=AnotherVeryComplexPassphaseForGPGEncrypti0n</code></p>
<p>and finally the duplicity command which will backup /source to /mega. The command is different for each server, as I tweak which files/folders I want to include/exclude in the backup:</p>
<p><code>duplicity --asynchronous-upload \<br />
--include=/source/var/lib/docker/containers \<br />
--include=/source/var/lib/plexmediaserver/Library/Application\ Support/Plex\ Media\ Server/Preferences.xml \<br />
--exclude=/source/dev \<br />
--exclude=/source/proc \<br />
--exclude=/source/run \<br />
--exclude=/source/sys \<br />
--exclude=/source/zfs \<br />
--exclude=/source/mnt \<br />
--exclude=/source/media \<br />
--exclude=/source/vol/dupmega/cache \<br />
--exclude=/source/tank \<br />
--exclude=/source/vbox \<br />
--exclude=/source/var/lib/docker \<br />
--exclude=/source/var/lib/plexmediaserver/ \<br />
--exclude=/source/tmp \<br />
--exclude=/source/var/tmp \<br />
--exclude=/source/var/cache \<br />
--exclude=/source/var/log \<br />
/source/ file:///mega/backups/$(hostname)/ -v info<br />
</code></p>
<p>And this would be a sample output:</p>
<p><code>Local and Remote metadata are synchronized, no sync needed.<br />
Last full backup date: Thu Oct 20 22:51:23 2016<br />
Deleting /tmp/duplicity-Cwz5Ju-tempdir/mktemp-0lEM40-2<br />
Using temporary directory /root/.cache/duplicity/185b874acbbae73c5807a4cc767e4967/duplicity-kYzeVT-tempdir<br />
Using temporary directory /root/.cache/duplicity/185b874acbbae73c5807a4cc767e4967/duplicity-jWJXmd-tempdir<br />
AsyncScheduler: instantiating at concurrency 1<br />
M boot/grub/grubenv<br />
A etc<br />
A etc/apparmor.d/cache<br />
M etc/apparmor.d/cache/docker<br />
[...]<br />
---------------[ Backup Statistics ]--------------<br />
StartTime 1477499247.82 (Wed Oct 26 16:27:27 2016)<br />
EndTime 1477499514.97 (Wed Oct 26 16:31:54 2016)<br />
ElapsedTime 267.15 (4 minutes 27.15 seconds)<br />
SourceFiles 449013<br />
SourceFileSize 3239446764 (3.02 GB)<br />
NewFiles 75<br />
NewFileSize 189457 (185 KB)<br />
DeletedFiles 135<br />
ChangedFiles 68<br />
ChangedFileSize 176144101 (168 MB)<br />
ChangedDeltaSize 0 (0 bytes)<br />
DeltaEntries 278<br />
RawDeltaSize 9317325 (8.89 MB)<br />
TotalDestinationSizeChange 1913375 (1.82 MB)<br />
Errors 0<br />
-------------------------------------------------<br />
</code></p>
<p>And backup are really stored on Mega <img src="https://s.w.org/images/core/emoji/2.3/72x72/1f609.png" alt="ðŸ˜‰" class="wp-smiley" style="height: 1em; max-height: 1em;" /> :</p>
<p><a href="http://itnerd.space/wp-content/uploads/2016/10/Screenshot-from-2016-10-27-01-10-42.png"><img data-attachment-id="13" data-permalink="http://itnerd.space/2016/10/26/offsite-backup-with-duplicity-and-mega/screenshot-from-2016-10-27-01-10-42/" data-orig-file="http://itnerd.space/wp-content/uploads/2016/10/Screenshot-from-2016-10-27-01-10-42.png" data-orig-size="1304,747" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="screenshot-from-2016-10-27-01-10-42" data-image-description="" data-medium-file="http://itnerd.space/wp-content/uploads/2016/10/Screenshot-from-2016-10-27-01-10-42-300x172.png" data-large-file="http://itnerd.space/wp-content/uploads/2016/10/Screenshot-from-2016-10-27-01-10-42-1024x587.png" class="aligncenter wp-image-13 size-large" src="http://itnerd.space/wp-content/uploads/2016/10/Screenshot-from-2016-10-27-01-10-42-1024x587.png" alt="backup files on Mega" width="700" height="401" srcset="http://itnerd.space/wp-content/uploads/2016/10/Screenshot-from-2016-10-27-01-10-42-1024x587.png 1024w, http://itnerd.space/wp-content/uploads/2016/10/Screenshot-from-2016-10-27-01-10-42-300x172.png 300w, http://itnerd.space/wp-content/uploads/2016/10/Screenshot-from-2016-10-27-01-10-42-768x440.png 768w, http://itnerd.space/wp-content/uploads/2016/10/Screenshot-from-2016-10-27-01-10-42.png 1304w" sizes="(max-width: 700px) 100vw, 700px" /></a></p>
]]></content:encoded>
			<wfw:commentRss>http://itnerd.space/2016/10/26/offsite-backup-with-duplicity-and-mega/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
	</channel>
</rss>
